{"name": "full_llm_pack_flow", "description": "Complete e2e: client sends message via HTTP API, agent (real LLM) invokes pack tool through gateway, response streams back to client via SSE", "given": ["gateway running locally with agent_auto_registration=approved", "test-pack connected and echo tool registered", "agent connected with mux backend and real Anthropic API key"], "when": ["client POSTs to /api/send with agent_id and content instructing agent to use echo tool with a sentinel string"], "then": ["SSE stream contains 'started' event", "SSE stream contains tool_use event with name='echo'", "SSE stream contains tool_result event", "SSE stream contains the sentinel string in output", "SSE stream completes with done event"], "validates": ["PackConfig loads correctly (FOLD_SERVER/FOLD_PORT env vars)", "test-pack registers tools with gateway via gRPC", "agent receives available_tools in Welcome message", "LLM correctly identifies and invokes pack tool", "gateway routes ExecutePackTool to correct pack", "pack executes tool and returns result via ToolResult RPC", "gateway delivers PackToolResult back to agent", "full SSE streaming from gateway to client works end-to-end"], "script": ".scratch/e2e_full_llm_pack_flow.sh", "requires": ["ANTHROPIC_API_KEY", "go compiler", "cargo/rust toolchain"], "timeout_seconds": 180}
{"name": "pack_config_env_override", "description": "PackConfig respects FOLD_SERVER/FOLD_PORT env vars over packs.toml defaults", "given": ["no ~/.config/fold/packs.toml exists or it has different values"], "when": ["FOLD_SERVER and FOLD_PORT env vars are set", "PackConfig::load is called"], "then": ["gateway_url uses env var values", "ssh_key_path is constructed correctly for the pack name"], "validates": ["env vars take precedence over config file", "config file takes precedence over defaults", "invalid port values fall back gracefully"], "script": "cargo test -p fold-pack config", "requires": ["cargo/rust toolchain"], "timeout_seconds": 30}
{"name": "pack_config_toml_loading", "description": "PackConfig loads server/port from ~/.config/fold/packs.toml when env vars are absent", "given": ["~/.config/fold/packs.toml exists with server and port fields", "FOLD_SERVER and FOLD_PORT env vars are NOT set"], "when": ["PackConfig::load is called"], "then": ["gateway_url uses values from packs.toml", "missing fields fall back to defaults (localhost:50051)"], "validates": ["TOML parsing handles full, partial, and empty configs", "invalid TOML gracefully falls back to defaults", "XDG config directory convention is respected"], "script": "cargo test -p fold-pack config", "requires": ["cargo/rust toolchain"], "timeout_seconds": 30}
{"name": "pack_registration_with_config", "description": "test-pack connects to gateway using PackConfig-resolved URL and registers tools", "given": ["gateway running on custom port", "FOLD_SERVER and FOLD_PORT env vars pointing to gateway"], "when": ["test-pack binary starts"], "then": ["pack connects to gateway via gRPC", "pack registers echo and admin_echo tools", "gateway logs show pack registration with 2 tools"], "validates": ["PackConfig integration in pack binary", "SSH key generation/loading at XDG path", "gRPC connection with SSH auth works", "tool manifest is correctly transmitted"], "script": ".scratch/e2e_full_llm_pack_flow.sh (steps 4-5)", "requires": ["go compiler", "cargo/rust toolchain"], "timeout_seconds": 60}
{"name": "agent_receives_pack_tools", "description": "Agent receives available pack tools in Welcome message after connecting to gateway", "given": ["gateway running with test-pack registered", "agent config points to local gateway with mux backend"], "when": ["agent connects to gateway"], "then": ["agent receives Welcome with available_tools list", "available_tools includes 'echo' from test-pack", "agent registers pack tools for LLM use"], "validates": ["gateway includes pack tools in Welcome message", "MCP token and endpoint are provided to agent", "agent backend receives tool definitions for LLM context"], "script": ".scratch/e2e_full_llm_pack_flow.sh (step 6)", "requires": ["ANTHROPIC_API_KEY", "go compiler", "cargo/rust toolchain"], "timeout_seconds": 60}
{"name": "live_gateway_full_flow", "description": "Complete e2e against deployed production gateway: pack and agent connect via Tailscale, client sends via HTTPS, LLM invokes pack tool, SSE streams back", "given": ["live gateway running at fold-gateway.porpoise-alkaline.ts.net", "Tailscale connectivity to gateway", "SSH key for test-pack at ~/.config/fold/packs/test-pack/id_ed25519", "JWT token at ~/.config/fold/token", "ANTHROPIC_API_KEY available"], "when": ["test-pack connects to live gateway gRPC port 50051", "agent connects with mux backend to live gateway", "client POSTs to HTTPS /api/send with sentinel echo instruction"], "then": ["test-pack registers 2 tools with live gateway", "agent registers and receives pack tools", "SSE stream contains started event", "SSE stream contains tool_use with echo tool", "SSE stream contains tool_result from pack", "SSE stream contains sentinel string", "SSE stream completes with done event"], "validates": ["PackConfig resolves live gateway via FOLD_SERVER/FOLD_PORT env vars", "SSH auth works against production gateway", "gRPC pack registration works over Tailscale network", "agent registration with live gateway succeeds", "LLM invokes correct pack tool on production system", "gateway routes tool execution across network to pack", "full HTTPS SSE streaming works end-to-end on production"], "script": ".scratch/e2e_live_gateway.sh", "requires": ["ANTHROPIC_API_KEY", "Tailscale connectivity", "cargo/rust toolchain", "~/.config/fold/packs/test-pack/id_ed25519", "~/.config/fold/token"], "timeout_seconds": 180}
