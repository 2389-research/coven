{"name": "new_session_no_resume", "description": "New sessions should not use --resume flag", "given": "is_new_session = true", "when": "CLI arguments are constructed", "then": "--resume flag is NOT present", "validates": "crates/fold-core/src/backend/direct_cli.rs:spawn_cli_process"}
{"name": "existing_session_uses_resume", "description": "Existing sessions should use --resume with session ID", "given": "is_new_session = false", "when": "CLI arguments are constructed", "then": "--resume <session_id> is present", "validates": "crates/fold-core/src/backend/direct_cli.rs:spawn_cli_process"}
{"name": "parse_session_init", "description": "SessionInit event extracts Claude's session ID", "given": "system init JSON from Claude CLI", "when": "JSON is parsed", "then": "SessionInit event with session_id is emitted", "validates": "crates/fold-core/src/backend/direct_cli.rs:parse_cli_event"}
{"name": "detect_orphaned_session", "description": "Orphaned session detected from stderr", "given": "stderr contains 'No conversation found with session ID'", "when": "stderr is processed", "then": "orphan_detected flag is set true", "validates": "crates/fold-core/src/backend/direct_cli.rs:process_cli_output"}
{"name": "parse_assistant_text", "description": "Text content extracted from assistant message", "given": "assistant JSON with text content", "when": "JSON is parsed", "then": "Text event is emitted", "validates": "crates/fold-core/src/backend/direct_cli.rs:parse_cli_event"}
{"name": "parse_tool_use", "description": "Tool use extracted from assistant message", "given": "assistant JSON with tool_use content", "when": "JSON is parsed", "then": "ToolUse event with id, name, input is emitted", "validates": "crates/fold-core/src/backend/direct_cli.rs:parse_cli_event"}
{"name": "parse_result_success", "description": "Success result parsed correctly", "given": "result JSON with is_error=false", "when": "JSON is parsed", "then": "Done event is emitted", "validates": "crates/fold-core/src/backend/direct_cli.rs:parse_cli_event"}
{"name": "parse_result_error", "description": "Error result parsed correctly", "given": "result JSON with is_error=true", "when": "JSON is parsed", "then": "Error event is emitted with message", "validates": "crates/fold-core/src/backend/direct_cli.rs:parse_cli_event"}
{"name": "atomic_orphan_flag", "description": "AtomicBool communicates orphan state between tasks", "given": "AtomicBool shared between stderr task and main task", "when": "stderr task sets flag, main task reads", "then": "Main task sees true value", "validates": "crates/fold-core/src/backend/direct_cli.rs:process_cli_output"}
{"name": "timeout_kills_process", "description": "Timeout triggers process kill", "given": "CLI process running with short timeout", "when": "timeout expires", "then": "child.kill() is called and Error event sent", "validates": "crates/fold-core/src/backend/direct_cli.rs:send"}
{"name": "router_updates_session_on_init", "description": "Router updates stored session ID on SessionInit", "given": "SessionInit event received from backend", "when": "router processes event", "then": "database and cache updated with new session ID", "validates": "crates/fold-core/src/router.rs:handle"}
{"name": "router_clears_session_on_orphan", "description": "Router clears session ID on SessionOrphaned", "given": "SessionOrphaned event received", "when": "router processes event", "then": "session ID cleared from database and cache, user gets retry error", "validates": "crates/fold-core/src/router.rs:handle"}
{"name": "e2e_first_message", "description": "First message creates session and gets response", "given": "New thread with no existing session", "when": "User sends first message", "then": "Session created, response received with Thinking and Done events", "validates": "Full stack: Fold router -> DirectCli backend -> Claude CLI", "verified": "2025-01-15"}
{"name": "e2e_session_continuation", "description": "Second message resumes session with context", "given": "Existing thread with stored session ID", "when": "User sends second message", "then": "Claude remembers context from first message", "validates": "Session ID storage and --resume flag logic", "verified": "2025-01-15"}
{"name": "mux_new_session", "description": "Mux backend creates new session with SQLx persistence", "given": "is_new_session = true", "when": "Backend.send() is called", "then": "SessionInit event emitted, session saved to mux_sessions table", "validates": "crates/fold-core/src/backend/mux.rs:send"}
{"name": "mux_load_existing_session", "description": "Mux backend loads existing session from database", "given": "is_new_session = false and session exists in DB", "when": "Backend.send() is called", "then": "Session loaded from SQLx pool, messages preserved", "validates": "crates/fold-core/src/backend/mux.rs:send"}
{"name": "mux_orphan_on_missing_session", "description": "Mux backend signals orphan for non-existent session", "given": "is_new_session = false and session NOT in DB", "when": "Backend.send() is called", "then": "SessionOrphaned event emitted, stream ends", "validates": "crates/fold-core/src/backend/mux.rs:send"}
{"name": "mux_tool_registry", "description": "8 built-in tools are registered on backend creation", "given": "MuxBackend::new() called with working_dir", "when": "Backend is initialized", "then": "read_file, write_file, edit, bash, list_files, search, web_fetch, web_search tools available", "validates": "crates/fold-core/src/backend/mux.rs:new"}
{"name": "mux_agentic_loop", "description": "Tool use triggers agentic loop continuation", "given": "LLM response with stop_reason = ToolUse", "when": "run_prompt processes response", "then": "Tool executed, result sent back to LLM, loop continues", "validates": "crates/fold-core/src/backend/mux.rs:run_prompt"}
{"name": "mux_streaming_text", "description": "Text chunks streamed as BackendEvent::Text", "given": "LLM streaming response with text deltas", "when": "StreamEvent::ContentBlockDelta received", "then": "BackendEvent::Text emitted for each delta", "validates": "crates/fold-core/src/backend/mux.rs:run_prompt"}
{"name": "mux_system_prompt_loading", "description": "System prompt loads from global and local files", "given": "~/.mux/system.md and working_dir/CLAUDE.md exist", "when": "build_system_prompt() called", "then": "Both prompts concatenated with working dir context", "validates": "crates/fold-core/src/backend/mux.rs:build_system_prompt"}
{"name": "mux_wd_tool_path_resolution", "description": "Working directory tools resolve relative paths", "given": "WdReadFileTool with working_dir=/home/user/project", "when": "execute({\"path\": \"src/main.rs\"}) called", "then": "Reads /home/user/project/src/main.rs", "validates": "crates/fold-core/src/backend/mux_tools.rs:resolve_path"}
